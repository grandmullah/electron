<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIXOLON Configuration Test - Port 18080</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .status { padding: 15px; margin: 15px 0; border-radius: 5px; }
        .status.connected { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status.disconnected { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .status.warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 12px 24px; margin: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; }
        .config-info { background: #e7f3ff; padding: 15px; border-radius: 5px; border: 1px solid #b3d9ff; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .endpoint-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
        .endpoint-item { padding: 15px; border: 1px solid #ddd; border-radius: 5px; text-align: center; }
        .endpoint-item.success { border-color: #28a745; background: #f8fff9; }
        .endpoint-item.failed { border-color: #dc3545; background: #fff8f8; }
        .endpoint-item.pending { border-color: #ffc107; background: #fffef8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîå BIXOLON Configuration Test</h1>
            <p>Testing your specific BIXOLON Web Print SDK configuration</p>
        </div>

        <div id="status" class="status warning">
            <h3>‚è≥ Testing BIXOLON Service on Port 18080...</h3>
            <p>This will test connection to your configured BIXOLON service</p>
        </div>

        <div class="config-info">
            <h3>üìã Your BIXOLON Configuration</h3>
            <ul>
                <li><strong>SDK:</strong> BIXOLON Web Print SDK V2.2.1</li>
                <li><strong>Printer:</strong> Bixolon SRP-350III (USB Connected)</li>
                <li><strong>Logical Name:</strong> Printer1</li>
                <li><strong>Port:</strong> 18080</li>
                <li><strong>Service:</strong> Web Print SDK Service</li>
                <li><strong>IP Detection:</strong> Dynamic (auto-detects current machine)</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üß™ Connection Tests</h3>
            <button onclick="testBIXOLONService()">Test BIXOLON Service</button>
            <button onclick="testPrintJob()">Test Print Job</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div class="test-section">
            <h3>üîó Endpoint Status</h3>
            <div class="endpoint-grid" id="endpointGrid">
                <div class="endpoint-item pending">
                    <h4>HTTP 192.168.9.82:18080</h4>
                    <p>Your configured service</p>
                    <div class="status-text">Pending...</div>
                </div>
                <div class="endpoint-item pending">
                    <h4>WebSocket 192.168.9.82:18080</h4>
                    <p>Real-time connection</p>
                    <div class="status-text">Pending...</div>
                </div>
                <div class="endpoint-item pending">
                    <h4>HTTP localhost:18080</h4>
                    <p>Local fallback</p>
                    <div class="status-text">Pending...</div>
                </div>
                <div class="endpoint-item pending">
                    <h4>WebSocket localhost:18080</h4>
                    <p>Local WebSocket</p>
                    <div class="status-text">Pending...</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>üìù Test Log</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- Load BIXOLON integration scripts -->
    <script type="text/javascript" src="js/bGateWebPrintAPI_WS.js"></script>
    <script type="text/javascript" src="js/thermal-printer-simulator.js"></script>

    <script>
        let apiInstance = null;
        let connectionResults = {};

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.className = type;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<h3>${message}</h3>`;
        }

        function updateEndpointItem(index, status, message) {
            const grid = document.getElementById('endpointGrid');
            const item = grid.children[index];
            if (item) {
                item.className = `endpoint-item ${status}`;
                item.querySelector('.status-text').textContent = message;
            }
        }

        async function testBIXOLONService() {
            log('üöÄ Testing BIXOLON service on port 18080...', 'info');
            
            // Test your specific configuration
            const endpoints = [
                { 
                    name: 'HTTP 192.168.9.82:18080', 
                    url: 'http://192.168.9.82:18080', 
                    type: 'http',
                    index: 0
                },
                { 
                    name: 'WebSocket 192.168.9.82:18080', 
                    url: 'ws://192.168.9.82:18080', 
                    type: 'ws',
                    index: 1
                },
                { 
                    name: 'HTTP localhost:18080', 
                    url: 'http://localhost:18080', 
                    type: 'http',
                    index: 2
                },
                { 
                    name: 'WebSocket localhost:18080', 
                    url: 'ws://localhost:18080', 
                    type: 'ws',
                    index: 3
                }
            ];

            let successCount = 0;

            for (const endpoint of endpoints) {
                try {
                    log(`üîç Testing ${endpoint.name}...`, 'info');
                    
                    if (endpoint.type === 'ws') {
                        const connected = await testWebSocket(endpoint.url);
                        if (connected) {
                            log(`‚úÖ ${endpoint.name} connection successful`, 'success');
                            updateEndpointItem(endpoint.index, 'success', 'Connected');
                            connectionResults[endpoint.name] = 'success';
                            successCount++;
                        } else {
                            log(`‚ùå ${endpoint.name} connection failed`, 'error');
                            updateEndpointItem(endpoint.index, 'failed', 'Failed');
                            connectionResults[endpoint.name] = 'failed';
                        }
                    } else {
                        const connected = await testHTTP(endpoint.url);
                        if (connected) {
                            log(`‚úÖ ${endpoint.name} connection successful`, 'success');
                            updateEndpointItem(endpoint.index, 'success', 'Connected');
                            connectionResults[endpoint.name] = 'success';
                            successCount++;
                        } else {
                            log(`‚ùå ${endpoint.name} connection failed`, 'error');
                            updateEndpointItem(endpoint.index, 'failed', 'Failed');
                            connectionResults[endpoint.name] = 'failed';
                        }
                    }
                } catch (error) {
                    log(`‚ùå ${endpoint.name} test error: ${error.message}`, 'error');
                    updateEndpointItem(endpoint.index, 'failed', 'Error');
                    connectionResults[endpoint.name] = 'failed';
                }
            }

            // Final status update
            if (successCount > 0) {
                updateStatus(`‚úÖ ${successCount} connection(s) successful!`, 'connected');
                log(`üéâ BIXOLON service test complete: ${successCount} successful connection(s)`, 'success');
                
                // Check if our API can connect
                if (window.bGateWebPrintAPI) {
                    apiInstance = window.bGateWebPrintAPI;
                    log('‚úÖ BIXOLON API wrapper available', 'success');
                    
                    // Try to connect
                    try {
                        const connected = await apiInstance.connect('Printer1');
                        if (connected) {
                            log('‚úÖ Successfully connected to BIXOLON printer via service', 'success');
                        } else {
                            log('‚ö†Ô∏è Failed to connect to BIXOLON printer', 'warning');
                        }
                    } catch (error) {
                        log(`‚ùå Connection error: ${error.message}`, 'error');
                    }
                }
            } else {
                updateStatus('‚ùå No connections successful', 'disconnected');
                log('‚ö†Ô∏è No connections successful. Check your BIXOLON service configuration.', 'warning');
                log('üí° Verify the service is running on 192.168.9.82:18080', 'info');
            }
        }

        async function testWebSocket(url) {
            return new Promise((resolve) => {
                try {
                    const ws = new WebSocket(url);
                    
                    ws.onopen = () => {
                        log(`üîå WebSocket connected to: ${url}`, 'success');
                        ws.close();
                        resolve(true);
                    };
                    
                    ws.onerror = () => {
                        log(`‚ùå WebSocket error connecting to: ${url}`, 'error');
                        resolve(false);
                    };
                    
                    // Timeout after 5 seconds
                    setTimeout(() => {
                        if (ws.readyState !== WebSocket.OPEN) {
                            ws.close();
                            resolve(false);
                        }
                    }, 5000);
                    
                } catch (error) {
                    log(`‚ùå WebSocket connection failed: ${error.message}`, 'error');
                    resolve(false);
                }
            });
        }

        async function testHTTP(url) {
            try {
                // Try multiple endpoints
                const endpoints = ['', '/status', '/api/status', '/health', '/printer/status'];
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(`${url}${endpoint}`, { 
                            method: 'GET',
                            mode: 'no-cors',
                            signal: AbortSignal.timeout(5000)
                        });
                        
                        if (response.ok || response.status === 0) { // no-cors returns status 0
                            log(`‚úÖ HTTP connection successful to: ${url}${endpoint}`, 'success');
                            return true;
                        }
                    } catch (endpointError) {
                        // Continue to next endpoint
                    }
                }
                
                return false;
            } catch (error) {
                log(`‚ùå HTTP connection failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testPrintJob() {
            log('üñ®Ô∏è Testing BIXOLON Print Job...', 'info');
            
            if (!apiInstance) {
                log('‚ùå No API instance available. Run service test first.', 'error');
                return;
            }

            if (!apiInstance.connected) {
                log('‚ùå Not connected to BIXOLON printer. Run service test first.', 'error');
                return;
            }

            try {
                const printJob = apiInstance.createPrintJob({
                    width: 80,
                    fontSize: 11,
                    fontFamily: 'monospace',
                    lineSpacing: 1.2,
                    margin: 0
                });

                log('‚úÖ Print job created successfully', 'success');

                // Add test content
                printJob.addText('BETZONE BIXOLON TEST');
                printJob.addLineBreak();
                printJob.addSeparator('=');
                printJob.addText('Date: ' + new Date().toLocaleString());
                printJob.addText('Test: Port 18080 Service');
                printJob.addLineBreak();
                printJob.addSeparator('=');
                printJob.addText('IP: 192.168.9.82:18080');
                printJob.addText('Printer: SRP-350III');
                printJob.addLineBreak();
                printJob.addText('Thank you for testing!');

                log('‚úÖ Content added to print job', 'success');

                // Execute the print job
                const result = await printJob.execute();
                log(`‚úÖ Print job completed: ${JSON.stringify(result)}`, 'success');

            } catch (error) {
                log(`‚ùå Print job test failed: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('üßπ Log cleared', 'info');
        }

        // Auto-run test when page loads
        window.addEventListener('load', () => {
            log('üöÄ Page loaded, testing BIXOLON service on port 18080...', 'info');
            setTimeout(() => {
                testBIXOLONService();
            }, 1000);
        });
    </script>
</body>
</html>
